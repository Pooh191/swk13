<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการเงินห้อง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light-bg: #f8fafc;
            --border: #e2e8f0;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .table-container {
            overflow-x: auto;
            position: relative;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .sticky-col {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 20;
            transition: background-color 0.2s;
        }
        
        .sticky-col:hover {
            background-color: #f8fafc;
        }
        
        .sticky-col.border-r {
            border-right: 2px solid var(--border);
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
            transition: all 0.2s;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .payment-input {
            width: 90px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-weight: 500;
            background: white;
        }
        
        .payment-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .payment-input:hover {
            border-color: #cbd5e1;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        thead th {
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            padding: 16px 20px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        tbody td {
            padding: 16px 20px;
            border-top: 1px solid #f1f5f9;
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8fafc;
        }
        
        .total-cell {
            font-weight: 700;
            color: var(--primary);
            background-color: #f0f9ff;
        }
        
        .balance-cell {
            font-weight: 600;
        }
        
        .positive-balance {
            color: var(--secondary);
        }
        
        .negative-balance {
            color: var(--danger);
        }
        
        .header-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 0 0 20px 20px;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 768px) {
            .header-gradient h1 {
                font-size: 1.5rem;
            }
            
            .payment-input {
                width: 70px;
                padding: 6px;
            }
            
            thead th, tbody td {
                padding: 12px 14px;
            }
        }
        
        .footer-info {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            margin-top: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-box {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin: 4px;
        }
        
        .stat-box i {
            margin-right: 12px;
            font-size: 1.5rem;
            color: var(--primary);
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center justify-start">
    <div class="container mx-auto max-w-7xl mt-4">
        <!-- Header -->
        <div class="header-gradient text-center">
            <h1 class="text-3xl sm:text-4xl font-bold mb-2">ระบบจัดการเงินห้อง</h1>
            <p class="opacity-90">จัดการการเก็บเงินรายสัปดาห์ของนักเรียน</p>
        </div>
        
        <!-- Main Content -->
        <div class="card p-6">
            <!-- Data Table -->
            <div class="table-container">
                <table id="data-table" class="min-w-full">
                    <thead>
                        <tr id="table-headers">
                            <th scope="col" class="sticky-col text-left z-20" style="min-width: 60px;">เลขที่</th>
                            <th scope="col" class="sticky-col text-left z-20" style="min-width: 100px; left: 60px;">เลขประจำตัว</th>
                            <th scope="col" class="sticky-col text-left z-20" style="min-width: 100px; left: 160px;">คำนำหน้า</th>
                            <th scope="col" class="sticky-col text-left z-20" style="min-width: 150px; left: 260px;">ชื่อ</th>
                            <th scope="col" class="sticky-col text-left z-20" style="min-width: 150px; left: 410px;">นามสกุล</th>
                            <th scope="col" colspan="15" class="text-center">จำนวนเงินที่เก็บแต่ละสัปดาห์</th>
                            <th scope="col" class="text-right" style="min-width: 100px;">ผลรวม</th>
                            <th scope="col" class="text-right" style="min-width: 120px;">ยอดคงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body" class="bg-white">
                        <tr>
                            <td colspan="100" class="px-6 py-8 text-center">
                                <div class="flex flex-col items-center justify-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-3xl mb-2 text-blue-500"></i>
                                    <p>กำลังโหลดข้อมูล...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Save button -->
            <div class="mt-8 flex justify-center">
                <button id="save-button" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    <span id="save-text">บันทึกข้อมูล</span>
                    <span id="save-spinner" class="loading ml-2 hidden"></span>
                </button>
            </div>
            
            <!-- Info Footer -->
            <div class="footer-info">
                <div class="stat-box">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <div class="text-sm text-gray-500">จำนวนนักเรียน</div>
                        <div class="font-bold" id="student-count">0</div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <i class="fas fa-coins"></i>
                    <div>
                        <div class="text-sm text-gray-500">ยอดรวมทั้งหมด</div>
                        <div class="font-bold" id="total-amount">0</div>
                    </div>
                </div>
                
                <div class="stat-box">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <div class="text-sm text-gray-500">อัปเดตล่าสุด</div>
                        <div class="font-bold" id="last-update">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for messages -->
    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center z-50 p-4" style="opacity: 0; visibility: hidden;">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white p-6 rounded-lg max-w-sm w-full mx-auto relative z-10 transform scale-95 opacity-0">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                    <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2" id="modal-title">แจ้งเตือน</h3>
                <p id="modal-text" class="text-gray-500"></p>
            </div>
            <div class="flex justify-center mt-6">
                <button id="close-modal" class="btn btn-primary">ตกลง</button>
            </div>
        </div>
    </div>

    <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjb2vK2udXhWyGAo34wB0TcXDVVqbfQYPm-PGs0Q7GGLxKg1Kh3eVwmZSYeDrx8b2NBA/exec';
    const dataTableBody = document.getElementById('data-table-body');
    const tableHeaders = document.getElementById('table-headers');
    const messageModal = document.getElementById('message-modal');
    const modalText = document.getElementById('modal-text');
    const modalTitle = document.getElementById('modal-title');
    const closeModalBtn = document.getElementById('close-modal');
    const saveButton = document.getElementById('save-button');
    const saveText = document.getElementById('save-text');
    const saveSpinner = document.getElementById('save-spinner');
    const studentCount = document.getElementById('student-count');
    const totalAmount = document.getElementById('total-amount');
    const lastUpdate = document.getElementById('last-update');

    let pendingUpdates = {};
    let dateHeaders = [];
    let allStudentsData = [];

    function showModal(message, title = 'แจ้งเตือน') {
        modalTitle.textContent = title;
        modalText.textContent = message;
        messageModal.style.opacity = '1';
        messageModal.style.visibility = 'visible';
        
        const modalContent = messageModal.querySelector('.modal-content');
        modalContent.style.transform = 'scale(1)';
        modalContent.style.opacity = '1';
    }

    function hideModal() {
        messageModal.style.opacity = '0';
        messageModal.style.visibility = 'hidden';
        
        const modalContent = messageModal.querySelector('.modal-content');
        modalContent.style.transform = 'scale(0.95)';
        modalContent.style.opacity = '0';
    }
    
    closeModalBtn.addEventListener('click', hideModal);

    function showLoading(show) {
        if (show) {
            saveText.textContent = 'กำลังบันทึก...';
            saveSpinner.classList.remove('hidden');
            saveButton.disabled = true;
        } else {
            saveText.textContent = 'บันทึกข้อมูล';
            saveSpinner.classList.add('hidden');
            saveButton.disabled = false;
        }
    }

    async function fetchData() {
        try {
            dataTableBody.innerHTML = `
                <tr>
                    <td colspan="100" class="px-6 py-8 text-center">
                        <div class="flex flex-col items-center justify-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-3xl mb-2 text-blue-500"></i>
                            <p>กำลังโหลดข้อมูล...</p>
                        </div>
                    </td>
                </tr>
            `;
            
            const response = await fetch(SCRIPT_URL + '?t=' + new Date().getTime());
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            allStudentsData = data.data || [];
            renderTable(data);
            updateFooterInfo();
        } catch (error) {
            console.error('Error fetching data:', error);
            showModal('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message, 'ข้อผิดพลาด');
            dataTableBody.innerHTML = `
                <tr>
                    <td colspan="100" class="px-6 py-8 text-center">
                        <div class="flex flex-col items-center justify-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>ไม่สามารถโหลดข้อมูลได้: ${error.message}</p>
                            <button class="mt-4 text-blue-500 hover:underline" onclick="fetchData()">
                                <i class="fas fa-redo mr-1"></i>ลองอีกครั้ง
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function renderTable(data) {
        dataTableBody.innerHTML = '';
        dateHeaders = data.dateHeaders || [];
        
        tableHeaders.innerHTML = `
            <th scope="col" class="sticky-col text-left z-20" style="min-width: 60px;">เลขที่</th>
            <th scope="col" class="sticky-col text-left z-20" style="min-width: 100px; left: 60px;">เลขประจำตัว</th>
            <th scope="col" class="sticky-col text-left z-20" style="min-width: 100px; left: 160px;">คำนำหน้า</th>
            <th scope="col" class="sticky-col text-left z-20" style="min-width: 150px; left: 260px;">ชื่อ</th>
            <th scope="col" class="sticky-col text-left z-20" style="min-width: 150px; left: 410px;">นามสกุล</th>
            ${dateHeaders.map((date, index) => 
                `<th scope="col" class="text-left" style="min-width: 100px;">${date}</th>`
            ).join('')}
            <th scope="col" class="text-right" style="min-width: 100px;">ผลรวม</th>
            <th scope="col" class="text-right" style="min-width: 120px;">ยอดคงเหลือ</th>
        `;

        if (!data.data || data.data.length === 0) {
            dataTableBody.innerHTML = `
                <tr>
                    <td colspan="100" class="px-6 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
                        <p>ไม่มีข้อมูลนักเรียน</p>
                    </td>
                </tr>
            `;
            return;
        }

        data.data.forEach((student, rowIndex) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            const fixedColumns = `
                <td class="sticky-col border-r font-medium">${student.stdId}</td>
                <td class="sticky-col border-r" style="left: 60px;">${student.studentId || ''}</td>
                <td class="sticky-col border-r" style="left: 160px;">${student.prefix || ''}</td>
                <td class="sticky-col border-r" style="left: 260px;">${student.firstName || ''}</td>
                <td class="sticky-col border-r" style="left: 410px;">${student.lastName || ''}</td>
            `;

            const paymentCells = (student.payments || []).map((payment, colIndex) => {
                const cellValue = payment > 0 ? payment : '';
                return `
                    <td>
                        <input
                            type="number"
                            value="${cellValue}"
                            data-row="${student.stdId}"
                            data-col="${colIndex + 6}"
                            class="payment-input"
                            oninput="handleInputChange(this)"
                        >
                    </td>
                `;
            }).join('');

            const balance = student.balance || 0;
            const balanceClass = balance >= 0 ? 'positive-balance' : 'negative-balance';
            
            const totalAndBalance = `
                <td class="total-cell text-right">${student.total || 0}</td>
                <td class="balance-cell text-right ${balanceClass}">${balance}</td>
            `;

            row.innerHTML = fixedColumns + paymentCells + totalAndBalance;
            dataTableBody.appendChild(row);
        });
    }
    
    function updateFooterInfo() {
        // Update student count
        studentCount.textContent = allStudentsData.length;
        
        // Calculate total amount
        const total = allStudentsData.reduce((sum, student) => sum + (student.total || 0), 0);
        totalAmount.textContent = total.toLocaleString();
        
        // Update last update time
        lastUpdate.textContent = new Date().toLocaleTimeString('th-TH');
    }
    
    function handleInputChange(input) {
        const row = parseInt(input.getAttribute('data-row'));
        const col = parseInt(input.getAttribute('data-col'));
        const value = input.value === '' ? 0 : parseFloat(input.value);
        
        if (!pendingUpdates[row]) {
            pendingUpdates[row] = {};
        }
        pendingUpdates[row][col] = value;
        
        updateRowTotals(input.closest('tr'));
    }
    
    function updateRowTotals(row) {
        let total = 0;
        const inputs = row.querySelectorAll('.payment-input');
        
        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        const totalCell = row.querySelector('.total-cell');
        const balanceCell = row.querySelector('.balance-cell');
        
        if (totalCell && balanceCell) {
            totalCell.textContent = total;
            
            // Calculate balance (assuming the expected total is 100 per week for 15 weeks = 1500)
            const expectedTotal = 1500;
            const balance = expectedTotal - total;
            
            // Update balance class based on value
            balanceCell.className = `balance-cell text-right ${balance >= 0 ? 'positive-balance' : 'negative-balance'}`;
            balanceCell.textContent = balance;
        }
    }

    async function saveAllData() {
        if (Object.keys(pendingUpdates).length === 0) {
            showModal('ไม่มีข้อมูลที่ต้องบันทึก', 'แจ้งเตือน');
            return;
        }

        try {
            showLoading(true);
            
            const params = new URLSearchParams();
            params.append('action', 'batchUpdate');
            params.append('updates', JSON.stringify(pendingUpdates));
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: params,
            });
            
            const responseText = await response.text();
            let result;
            
            try {
                result = JSON.parse(responseText);
            } catch (e) {
                console.warn('Response is not JSON:', responseText);
                result = { success: true, message: 'บันทึกข้อมูลสำเร็จ' };
            }
            
            if (result.success) {
                showModal('บันทึกข้อมูลเรียบร้อยแล้ว', 'สำเร็จ');
                pendingUpdates = {};
                
                // Update last update time
                lastUpdate.textContent = new Date().toLocaleTimeString('th-TH');
                
                setTimeout(() => {
                    hideModal();
                    fetchData();
                }, 1500);
            } else {
                showModal('การอัปเดตข้อมูลล้มเหลว: ' + (result.message || 'ไม่ทราบสาเหตุ'), 'ข้อผิดพลาด');
            }
        } catch (error) {
            console.error('Error saving data:', error);
            showModal('เกิดข้อผิดพลาดในการเชื่อมต่อเพื่อบันทึกข้อมูล: ' + error.message, 'ข้อผิดพลาด');
        } finally {
            showLoading(false);
        }
    }
    
    // Make functions available globally for inline event handlers
    window.handleInputChange = handleInputChange;
    window.fetchData = fetchData;
    
    saveButton.addEventListener('click', saveAllData);
    document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
