<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเงินห้องชั้นมัธยมศึกษาปีที่ 3/13 โรงเรียนสุรวิทยาคาร</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .container {
            max-width: 960px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #22c55e; /* Green 500 */
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #16a34a; /* Green 600 */
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #ef4444; /* Red 500 */
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Red 600 */
            transform: translateY(-1px);
        }
        .btn-info {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-info:hover {
            background-color: #2563eb; /* Blue 600 */
            transform: translateY(-1px);
        }
        input[type="text"], input[type="number"], select, textarea {
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #d1d5db; /* Gray 300 */
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: #4f46e5; /* Indigo 600 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Focus ring */
        }
        /* General income/expense text colors for list items (now table cells) */
        .income-text {
            color: #16a34a; /* Green 600 */
            font-weight: 600;
        }
        .expense-text {
            color: #dc2626; /* Red 600 */
            font-weight: 600;
        }

        /* Updated Summary Card Styling */
        .summary-card {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); /* Indigo gradient */
            color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            text-align: center; /* Center align content */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .summary-card h2 {
            color: white; /* Ensure header is white */
        }
        .summary-card .text-lg {
            color: #e0e7ff; /* Lighter text for labels */
        }
        /* Specific colors for summary values */
        .summary-card .income-text {
            color: #4ade80; /* Green 400 for income in summary */
        }
        .summary-card .expense-text {
            color: #f87171; /* Red 400 for expense in summary */
        }
        .summary-card .summary-net-balance-text {
            color: #fde047; /* Yellow 300 for net balance in summary (positive/zero) */
        }
        .summary-card .summary-net-balance-text.negative {
            color: #fca5a5; /* Light red for negative balance in summary for clarity */
        }

        /* New styles for summary boxes based on image */
        .summary-item-box {
            background-color: white;
            border-radius: 0.75rem; /* rounded-lg */
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px; /* Ensure consistent height */
        }
        .summary-item-income {
            background-color: #ecfdf5; /* Green 50 */
            border: 1px solid #a7f3d0; /* Green 200 */
        }
        .summary-item-expense {
            background-color: #fef2f2; /* Red 50 */
            border: 1px solid #fecaca; /* Red 200 */
        }
        .summary-item-balance {
            background-color: #eff6ff; /* Blue 50 */
            border: 1px solid #bfdbfe; /* Blue 200 */
        }
        .summary-item-text {
            color: #374151; /* Gray 700 */
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .summary-item-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
        }
        /* Specific colors for values inside summary boxes */
        .summary-item-income .summary-item-value {
            color: #10b981; /* Green 600 */
        }
        .summary-item-expense .summary-item-value {
            color: #ef4444; /* Red 500 */
        }
        .summary-item-balance .summary-item-value {
            color: #3b82f6; /* Blue 500 */
        }
        .summary-item-balance .summary-item-value.negative {
            color: #ef4444; /* Red 500 for negative balance in summary box */
        }


        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280; /* Gray 500 */
        }
        .close-button:hover {
            color: #1f2937; /* Gray 900 */
        }

        /* Table specific styles */
        .transaction-table-container {
            overflow-x: auto; /* Enable horizontal scrolling on small screens */
            width: 100%;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .transaction-table th, .transaction-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb; /* Gray 200 */
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        .transaction-table th {
            background-color: #f9fafb; /* Gray 50 */
            font-weight: 600;
            color: #4b5563; /* Gray 700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
        }
        .transaction-table tbody tr:hover {
            background-color: #f3f4f6; /* Gray 100 */
        }
        .transaction-table td:last-child {
            text-align: right; /* Align action buttons to the right */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto text-center">
            <h1 class="text-3xl font-bold">ระบบเงินห้องชั้นมัธยมศึกษาปีที่ 3/13 โรงเรียนสุรวิทยาคาร</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Transaction Form -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <div class="card p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">เพิ่มรายการใหม่</h2>
                <form id="transaction-form" class="space-y-4">
                    <div>
                        <label for="type" class="block text-gray-700 font-medium mb-1">ประเภท</label>
                        <select id="type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="income">รายรับ</option>
                            <option value="expense">รายจ่าย</option>
                        </select>
                    </div>

                    <div>
                        <label id="description-label" for="description" class="block text-gray-700 font-medium mb-1">รายการ</label>
                        <input type="text" id="description" placeholder="ค่าขนม, ค่าอุปกรณ์" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>

                    <div>
                        <label id="amount-label" for="amount" class="block text-gray-700 font-medium mb-1">จำนวนเงิน</label>
                        <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>

                    <div>
                        <label id="party-label" for="party" class="block text-gray-700 font-medium mb-1">ผู้รับ/ผู้มอบ</label>
                        <input type="text" id="party" placeholder="ชื่อผู้รับเงิน / ผู้มอบเงิน" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>

                    <div>
                        <label id="notes-label" for="notes" class="block text-gray-700 font-medium mb-1">หมายเหตุ (ไม่บังคับ)</label>
                        <textarea id="notes" rows="2" placeholder="รายละเอียดเพิ่มเติม" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>

                    <button type="submit" class="w-full py-3 btn-primary text-lg font-semibold">บันทึกรายการ</button>
                </form>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">สรุปยอดเงิน</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="summary-item-box summary-item-income">
                    <span class="summary-item-text">รวมรายรับ</span>
                    <span id="summary-income" class="summary-item-value">0.00 ฿</span>
                </div>
                <div class="summary-item-box summary-item-expense">
                    <span class="summary-item-text">รวมรายจ่าย</span>
                    <span id="summary-expense" class="summary-item-value">0.00 ฿</span>
                </div>
                <div class="summary-item-box summary-item-balance">
                    <span class="summary-item-text">คงเหลือสุทธิ</span>
                    <span id="summary-net-balance" class="summary-item-value">0.00 ฿</span>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="card p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">รายการทั้งหมด</h2>
            <div class="mb-4 flex flex-col sm:flex-row gap-2">
                <select id="filter-type" class="w-full sm:w-auto p-2 border border-gray-300 rounded-lg">
                    <option value="all">ทั้งหมด</option>
                    <option value="income">รายรับ</option>
                    <option value="expense">รายจ่าย</option>
                </select>
                <select id="sort-by" class="w-full sm:w-auto p-2 border border-gray-300 rounded-lg">
                    <option value="date-desc">วันที่ (ใหม่สุด)</option>
                    <option value="date-asc">วันที่ (เก่าสุด)</option>
                    <option value="amount-desc">จำนวนเงิน (มากสุด)</option>
                    <option value="amount-asc">จำนวนเงิน (น้อยสุด)</option>
                </select>
                <input type="text" id="search-input" placeholder="ค้นหารายการ..." class="w-full sm:flex-grow p-2 border border-gray-300 rounded-lg">
            </div>
            <div class="transaction-table-container">
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>วันที่</th>
                            <th>ประเภท</th>
                            <th>ผู้รับ/ผู้มอบ</th>
                            <th>หมายเหตุ</th>
                            <th>จำนวนเงิน</th>
                            <th>คงเหลือ</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list">
                        <!-- Transactions will be loaded here -->
                        <tr><td colspan="7" class="text-center text-gray-500 py-4">ยังไม่มีรายการ</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center mt-auto">
        <div class="container mx-auto">
            <p>&copy; <span id="current-year"></span> ระบบเงินห้องชั้นมัธยมศึกษาปีที่ 3/13 โรงเรียนสุรวิทยาคาร</p>
        </div>
    </footer>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal-button">&times;</span>
            <h3 class="text-xl font-semibold mb-4">ยืนยันการลบรายการ</h3>
            <p class="mb-6">คุณต้องการลบรายการนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-delete-btn" class="btn-danger px-4 py-2">ลบ</button>
                <button id="cancel-delete-btn" class="btn-info px-4 py-2">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-edit-modal-button">&times;</span>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">แก้ไขรายการ</h3>
            <form id="edit-transaction-form" class="space-y-4">
                <input type="hidden" id="edit-transaction-id">

                <div>
                    <label for="edit-type" class="block text-gray-700 font-medium mb-1">ประเภท</label>
                    <select id="edit-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="income">รายรับ</option>
                        <option value="expense">รายจ่าย</option>
                    </select>
                </div>

                <div>
                    <label id="edit-description-label" for="edit-description" class="block text-gray-700 font-medium mb-1">รายการ</label>
                    <input type="text" id="edit-description" placeholder="ค่าขนม, ค่าอุปกรณ์" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div>
                    <label id="edit-amount-label" for="edit-amount" class="block text-gray-700 font-medium mb-1">จำนวนเงิน</label>
                    <input type="number" id="edit-amount" placeholder="0.00" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div>
                    <label id="edit-party-label" for="edit-party" class="block text-gray-700 font-medium mb-1">ผู้รับ/ผู้มอบ</label>
                    <input type="text" id="edit-party" placeholder="ชื่อผู้รับเงิน / ผู้มอบเงิน" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div>
                    <label id="edit-notes-label" for="edit-notes" class="block text-gray-700 font-medium mb-1">หมายเหตุ (ไม่บังคับ)</label>
                    <textarea id="edit-notes" rows="2" placeholder="รายละเอียดเพิ่มเติม" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <button type="submit" class="w-full py-3 btn-primary text-lg font-semibold">บันทึกการแก้ไข</button>
                <button type="button" id="cancel-edit-modal-btn" class="w-full py-3 btn-info text-lg font-semibold">ยกเลิก</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set current year in footer
            document.getElementById('current-year').textContent = `2024 - ${new Date().getFullYear()}`;

            const transactionForm = document.getElementById('transaction-form');
            const typeInput = document.getElementById('type');
            const descriptionInput = document.getElementById('description');
            const amountInput = document.getElementById('amount');
            const partyInput = document.getElementById('party');
            const notesInput = document.getElementById('notes');
            const transactionListBody = document.getElementById('transaction-list'); // Changed to tbody
            const filterTypeSelect = document.getElementById('filter-type');
            const sortBySelect = document.getElementById('sort-by');
            const searchInput = document.getElementById('search-input');

            // Labels for main form
            const amountLabel = document.getElementById('amount-label');
            const partyLabel = document.getElementById('party-label');

            // Summary elements
            const summaryIncomeDisplay = document.getElementById('summary-income');
            const summaryExpenseDisplay = document.getElementById('summary-expense');
            const summaryNetBalanceDisplay = document.getElementById('summary-net-balance');

            // Confirmation Modal elements
            const confirmationModal = document.getElementById('confirmation-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            let transactionToDeleteId = null; // To store the ID of the transaction to be deleted

            // Edit Transaction Modal elements
            const editTransactionModal = document.getElementById('edit-transaction-modal');
            const closeEditModalButton = document.getElementById('close-edit-modal-button');
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editTransactionIdInput = document.getElementById('edit-transaction-id');
            const editTypeInput = document.getElementById('edit-type');
            const editDescriptionInput = document.getElementById('edit-description');
            const editAmountInput = document.getElementById('edit-amount');
            const editPartyInput = document.getElementById('edit-party');
            const editNotesInput = document.getElementById('edit-notes');
            const cancelEditModalBtn = document.getElementById('cancel-edit-modal-btn');

            // Labels for edit modal form
            const editAmountLabel = document.getElementById('edit-amount-label');
            const editPartyLabel = document.getElementById('edit-party-label');


            let transactions = []; // Array to store all transactions

            // Function to generate a unique ID
            const generateId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            };

            // Function to update form field labels and placeholders based on transaction type
            const updateFormFields = (formType, typeValue) => {
                let currentAmountLabel, currentAmountInput, currentPartyLabel, currentPartyInput;

                if (formType === 'main') {
                    currentAmountLabel = amountLabel;
                    currentAmountInput = amountInput;
                    currentPartyLabel = partyLabel;
                    currentPartyInput = partyInput;
                } else if (formType === 'edit') {
                    currentAmountLabel = editAmountLabel;
                    currentAmountInput = editAmountInput;
                    currentPartyLabel = editPartyLabel;
                    currentPartyInput = editPartyInput;
                }

                if (typeValue === 'income') {
                    currentAmountLabel.textContent = 'จำนวนเงินที่ได้รับ';
                    currentAmountInput.placeholder = 'เช่น 500.00';
                    currentPartyLabel.textContent = 'ผู้มอบเงิน';
                    currentPartyInput.placeholder = 'เช่น นายสมชาย ใจดี';
                } else { // expense
                    currentAmountLabel.textContent = 'จำนวนเงินที่ถอน';
                    currentAmountInput.placeholder = 'เช่น 250.00';
                    currentPartyLabel.textContent = 'ผู้รับเงิน';
                    currentPartyInput.placeholder = 'เช่น นางสาวสมหญิง ใช้จ่าย';
                }
            };


            // Load transactions from localStorage
            const loadTransactions = () => {
                const storedTransactions = localStorage.getItem('classroomTransactions');
                if (storedTransactions) {
                    transactions = JSON.parse(storedTransactions);
                }
                renderTransactions();
                updateBalancesAndSummary(); // Call combined update
                updateFormFields('main', typeInput.value); // Set initial labels for main form
            };

            // Save transactions to localStorage
            const saveTransactions = () => {
                localStorage.setItem('classroomTransactions', JSON.stringify(transactions));
            };

            // Update total balance display and summary
            const updateBalancesAndSummary = () => {
                let totalIncome = 0;
                let totalExpense = 0;

                transactions.forEach(transaction => {
                    if (transaction.type === 'income') {
                        totalIncome += transaction.amount;
                    } else {
                        totalExpense += transaction.amount;
                    }
                });

                const netBalance = totalIncome - totalExpense;

                // Update summary card
                summaryIncomeDisplay.textContent = `${totalIncome.toFixed(2)} ฿`;
                summaryExpenseDisplay.textContent = `${totalExpense.toFixed(2)} ฿`;
                summaryNetBalanceDisplay.textContent = `${netBalance.toFixed(2)} ฿`;
                // Apply styling based on net balance for the summary card
                summaryNetBalanceDisplay.classList.remove('negative'); // Remove previous state
                if (netBalance < 0) {
                    summaryNetBalanceDisplay.classList.add('negative');
                }
            };

            // Render transactions to the table
            const renderTransactions = () => {
                transactionListBody.innerHTML = ''; // Clear existing list

                let filteredTransactions = [...transactions];

                // Apply filter
                const filterType = filterTypeSelect.value;
                if (filterType !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
                }

                // Apply search
                const searchTerm = searchInput.value.toLowerCase();
                if (searchTerm) {
                    filteredTransactions = filteredTransactions.filter(t =>
                        t.description.toLowerCase().includes(searchTerm) ||
                        t.party.toLowerCase().includes(searchTerm) ||
                        t.notes.toLowerCase().includes(searchTerm)
                    );
                }

                // Create a temporary array to hold transactions with their running balance
                const transactionsWithBalance = [];
                let tempBalance = 0;
                // Sort by original date ascending to calculate running balance correctly
                const sortedByDateAsc = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedByDateAsc.forEach(transaction => {
                    if (transaction.type === 'income') {
                        tempBalance += transaction.amount;
                    } else {
                        tempBalance -= transaction.amount;
                    }
                    transactionsWithBalance.push({ ...transaction, runningBalance: tempBalance });
                });

                // Now apply filtering and user's desired sorting to transactionsWithBalance
                let displayTransactions = [...transactionsWithBalance];

                if (filterType !== 'all') {
                    displayTransactions = displayTransactions.filter(t => t.type === filterType);
                }

                if (searchTerm) {
                    displayTransactions = displayTransactions.filter(t =>
                        t.description.toLowerCase().includes(searchTerm) ||
                        t.party.toLowerCase().includes(searchTerm) ||
                        t.notes.toLowerCase().includes(searchTerm)
                    );
                }

                // Apply sort for display
                const sortBy = sortBySelect.value;
                displayTransactions.sort((a, b) => {
                    if (sortBy === 'date-desc') {
                        return new Date(b.date) - new Date(a.date);
                    } else if (sortBy === 'date-asc') {
                        return new Date(a.date) - new Date(b.date);
                    } else if (sortBy === 'amount-desc') {
                        return b.amount - a.amount;
                    } else if (sortBy === 'amount-asc') {
                        return a.amount - b.amount;
                    }
                    return 0;
                });


                if (displayTransactions.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="7" class="text-center text-gray-500 py-4">ยังไม่มีรายการ</td>`;
                    transactionListBody.appendChild(row);
                    return;
                }

                displayTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(transaction.date).toLocaleDateString('th-TH')}</td>
                        <td><span class="${transaction.type === 'income' ? 'income-text' : 'expense-text'}">${transaction.type === 'income' ? 'รายรับ' : 'รายจ่าย'}</span></td>
                        <td>${transaction.party}</td>
                        <td>${transaction.notes || '-'}</td>
                        <td class="${transaction.type === 'income' ? 'income-text' : 'expense-text'}">${transaction.amount.toFixed(2)} ฿</td>
                        <td class="${transaction.runningBalance >= 0 ? 'income-text' : 'expense-text'}">${transaction.runningBalance.toFixed(2)} ฿</td>
                        <td>
                            <div class="flex space-x-2 justify-end">
                                <button data-id="${transaction.id}" class="edit-btn btn-info px-3 py-1 text-sm">แก้ไข</button>
                                <button data-id="${transaction.id}" class="delete-btn btn-danger px-3 py-1 text-sm">ลบ</button>
                            </div>
                        </td>
                    `;
                    transactionListBody.appendChild(row);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => openEditModal(e.target.dataset.id));
                });
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => showDeleteConfirmation(e.target.dataset.id));
                });
            };

            // Add new transaction
            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const newTransaction = {
                    id: generateId(),
                    type: typeInput.value,
                    description: descriptionInput.value.trim(),
                    amount: parseFloat(amountInput.value),
                    party: partyInput.value.trim(),
                    notes: notesInput.value.trim(),
                    date: new Date().toISOString() // Current date and time
                };

                if (!newTransaction.description || isNaN(newTransaction.amount) || newTransaction.amount <= 0 || !newTransaction.party) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (รายการ, จำนวนเงิน, ผู้รับ/ผู้มอบ)');
                    return;
                }

                transactions.push(newTransaction);
                saveTransactions();
                renderTransactions();
                updateBalancesAndSummary();
                transactionForm.reset(); // Clear form
                updateFormFields('main', typeInput.value); // Reset labels after clearing
            });

            // Open Edit Modal function
            const openEditModal = (id) => {
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    editTransactionIdInput.value = transaction.id;
                    editTypeInput.value = transaction.type;
                    editDescriptionInput.value = transaction.description;
                    editAmountInput.value = transaction.amount;
                    editPartyInput.value = transaction.party;
                    editNotesInput.value = transaction.notes;

                    // Update labels and placeholders in edit modal immediately
                    updateFormFields('edit', transaction.type);

                    editTransactionModal.style.display = 'flex'; // Show modal
                }
            };

            // Handle Edit Modal submission
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const id = editTransactionIdInput.value;
                const type = editTypeInput.value;
                const description = editDescriptionInput.value.trim();
                const amount = parseFloat(editAmountInput.value);
                const party = editPartyInput.value.trim();
                const notes = editNotesInput.value.trim();

                if (!description || isNaN(amount) || amount <= 0 || !party) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง (รายการ, จำนวนเงิน, ผู้รับ/ผู้มอบ)');
                    return;
                }

                const index = transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    transactions[index] = { id, type, description, amount, party, notes, date: transactions[index].date }; // Keep original date
                }

                saveTransactions();
                renderTransactions();
                updateBalancesAndSummary();
                editTransactionModal.style.display = 'none'; // Hide modal
                editTransactionForm.reset(); // Clear modal form
                updateFormFields('edit', editTypeInput.value); // Reset labels after clearing
            });

            // Close Edit Modal
            closeEditModalButton.addEventListener('click', () => {
                editTransactionModal.style.display = 'none';
                editTransactionForm.reset();
                updateFormFields('edit', editTypeInput.value); // Reset labels after closing
            });
            cancelEditModalBtn.addEventListener('click', () => {
                editTransactionModal.style.display = 'none';
                editTransactionForm.reset();
                updateFormFields('edit', editTypeInput.value); // Reset labels after closing
            });


            // Show delete confirmation modal
            const showDeleteConfirmation = (id) => {
                transactionToDeleteId = id;
                confirmationModal.style.display = 'flex'; // Show modal
            };

            // Delete transaction function (called after confirmation)
            const deleteTransaction = () => {
                if (transactionToDeleteId) {
                    transactions = transactions.filter(t => t.id !== transactionToDeleteId);
                    saveTransactions();
                    renderTransactions();
                    updateBalancesAndSummary(); // Call combined update
                    transactionToDeleteId = null; // Clear ID
                    confirmationModal.style.display = 'none'; // Hide modal
                }
            };

            // Event listeners for confirmation modal buttons
            closeModalButton.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                transactionToDeleteId = null;
            });
            cancelDeleteBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
                transactionToDeleteId = null;
            });
            confirmDeleteBtn.addEventListener('click', deleteTransaction);

            // Filter and sort event listeners
            filterTypeSelect.addEventListener('change', renderTransactions);
            sortBySelect.addEventListener('change', renderTransactions);
            searchInput.addEventListener('input', renderTransactions);

            // Event listeners for dynamic labels
            typeInput.addEventListener('change', (e) => updateFormFields('main', e.target.value));
            editTypeInput.addEventListener('change', (e) => updateFormFields('edit', e.target.value));


            // Initial load
            loadTransactions();
        });
    </script>
</body>
</html>
